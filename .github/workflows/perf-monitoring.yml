name: Performance + robots.txt Monitoring on Prod

on:
  push:
    branches:
      - master

jobs:
  jmeter-tests:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Install dependencies
        run: npm ci

      - name: Cache JMeter
        id: cache-jmeter
        uses: actions/cache@v4
        with:
          path: ./apache-jmeter-5.6.3
          key: jmeter-${{ runner.os }}-v5.6.3

      - name: Download JMeter if not cached
        if: steps.cache-jmeter.outputs.cache-hit != 'true'
        run: |
          wget https://dlcdn.apache.org//jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      - name: Add JMeter to PATH
        run: echo "$PWD/apache-jmeter-5.6.3/bin" >> $GITHUB_PATH

      - name: Create report directories
        run: |
          mkdir -p ./report
          mkdir -p ./result
          mkdir -p ./errors

      - name: Run JMeter - Home Page
        run: |
          mkdir -p ./report/home-page
          jmeter -n -t ./tests/jmeter-tests/home-page-5.jmx \
            -l ./report/home-page/home-page-5.jtl \
            -Jjmeter.save.saveservice.output_format=xml \
            -Jjmeter.save.saveservice.print_field_names=true \
            -Jjmeter.save.saveservice.response_data.on_error=true \
            -Jjmeter.save.saveservice.bytes=true \
            -Jjmeter.save.saveservice.timestamp_format=ms;

          cp ./report/home-page/home-page-5.jtl ./result/home-page-5.jtl || true

      - name: 5-1-FINAL VALIDATION & SUMMARY TEST REPORT 
        run: |

          npx tsx scripts/home-page-jmeter-validator-5.ts

      - name: Run JMeter - Home Page
        run: |
          mkdir -p ./report/home-page
          jmeter -n -t ./tests/jmeter-tests/home-page-5.jmx \
            -l ./report/home-page/home-page-5.jtl \
            -Jjmeter.save.saveservice.output_format=xml \
            -Jjmeter.save.saveservice.print_field_names=true \
            -Jjmeter.save.saveservice.response_data.on_error=true \
            -Jjmeter.save.saveservice.bytes=true \
            -Jjmeter.save.saveservice.timestamp_format=ms;

          cp ./report/home-page/home-page-5.jtl ./result/home-page-5.jtl || true

      - name: 5-2-FINAL VALIDATION & SUMMARY TEST REPORT 
        run: |

          npx tsx scripts/home-page-jmeter-validator-5.ts
