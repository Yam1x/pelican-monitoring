# CI/CD Пайплайн для мониторинга производительности, безопасности и доступности на продакшене

Данный пайплайн GitHub Actions (`Perf + Security + Accessibility Monitoring on Prod`) будет запускаться по расписанию раз в час. 

Он мониторит прод сайта Челябинского зоопарка (https://chelzoo.ru) на:
- ключевые показатели web-vitals
- безопасность
- доступность 
- производительность под нагрузкой 
- время жизни кэша и соответствие robots.txt. 

**Структура:**  
Джобы выполняются параллельно, но возможен переезд на ожидание запуска Apache Jmeter нагрузочных тестов только после выполнения Lighthouse CI, чтобы нагрузка не аффектились показатели производительности.

- **validate-robots:** Быстрая проверка на полный мэтч содержимого по договоренности  
- **jmeter-tests:** Тестирование под нагрузкой 300 запросов за 30-60с (5 человек в секунду стучатся на страницы сайта)
- **lighthouse:** Аудит страницы через Lighthouse CI
- **validate-cache-headers:** Валидация кэша картинок через Playwright

Джобы независимы; сбой в одном не блокирует другие, но весь пайплайн считается неудачным, если хотя бы одна джоба с ошибкой.

## Проверяемые параметры

### 1. Валидация robots.txt
- **Что проверяет:** Загружает https://chelzoo.ru/robots.txt и сравнивает с ожидаемым содержимым (disallow /components, host HTTPS, ссылка на sitemap).  
- **Приемлемые значения:** Точное совпадение с ожидаемым (никаких вариаций — ошибка при любом несоответствии).  
- **Инструмент:** Curl + diff в пайплайне (просто, быстро, без зависимостей).

### 2. Нагрузочные Тесты JMeter
- **Что проверяет:** Симулирует нагрузку на страницы (Главная, Документы, Новости): 5 запросов/сек в течение 60 циклов (~300 запросов всего). Измеряет максимальное и среднее время отклика, перцентили, ошибки.  
- **Приемлемые значения:** Среднее <1500 мс, максимальное < 5000 мс,  0 ошибок  

- **Инструмент: Apache JMeter**  
  - **Почему JMeter вместо StepCI?** StepCI имел баги (например, отрицательное время отклика — недопустимые данные). 
  
  JMeter надежный, опенсорс и золотой стандарт для нагрузочного тестирования: 
  - Поддерживает сложные сценарии, 
  - Красивые отчеты при необходимости
  - Большое коммьюнити и общее признание (используется предприятиями вроде Netflix). 


### 3. Аудиты Lighthouse (через Lighthouse CI +  скрипт-валидатор)
- **Что проверяет:** Проводит аудит важных показателей отрисовки контента на странице, безопасность, доступность.   
- **Метрики Производительности (из CWV):**  
  - **[First Contentful Paint (FCP)](https://developer.chrome.com/docs/lighthouse/performance/first-contentful-paint?hl=ru):** Время до первого рендера контента. Warn: ≤1800 мс, Error: ≤3000 мс. 
  - **[Largest Contentful Paint (LCP)](https://developer.chrome.com/docs/lighthouse/performance/lighthouse-largest-contentful-paint?hl=ru):** Время загрузки основного контента (например, hero-изображение). Warn: ≤2400 мс, Error: ≤4000 мс.
  - **[Speed Index (SI)](https://developer.chrome.com/docs/lighthouse/performance/speed-index?hl=ru):** Индекс скорости измеряет, насколько быстро контент отображается визуально во время загрузки страницы. Warn: ≤2300 мс, Error: ≤5000 мс. 
  - **[Total Blocking Time (TBT)](https://developer.chrome.com/docs/lighthouse/performance/lighthouse-total-blocking-time?hl=ru):** TBT измеряет общее время, в течение которого страница не может реагировать на вводимые пользователем данные, такие как щелчки мыши, касания экрана или нажатия клавиатуры.
   Warn: ≤150 мс, Error: ≤350 мс.
  - **[Interactive](https://developer.chrome.com/docs/lighthouse/performance/interactive?hl=ru):** TTI измеряет, сколько времени требуется странице, чтобы стать полностью интерактивной.  Error: ≤5000 мс (без warn). Почему? Ограничивает экстремальные задержки; фокус на других метриках для нюансов.  
- **Метрики Безопасности (мин. балл 100/100 — ошибка при <100):**  
  - **CSP-XSS:** Content-Security-Policy против XSS (XSS - XSS (Cross-Site Scripting) — это уязвимость, при которой злоумышленник внедряет на страницу вредоносный JavaScript (или HTML), который потом выполняется в браузере.)
  - **Is on HTTPS:** Полное использование HTTPS
  - **Redirects HTTP:** Автоматический редирект HTTP на HTTPS  
  - **Has HSTS:** HTTP Strict Transport Security. 
  Заголовок ответа HTTP Strict Transport Security (HSTS) , который заставляет браузер пользователя посещать веб-сайт только с использованием TLS (Transport Layer Security) и не возвращаться к открытому текстовому HTTP 
- **Метрики предупреждений:**  
  - **Uses HTTP/2:** Современный протокол для быстрых загрузок. HTTP/2 обслуживает ресурсы вашей страницы быстрее и с меньшим объемом данных, передаваемых по сети.
  - **Uses rel=preconnect:** Предварительное подключение к внешним доменам. Почему? Экономит 100-500 мс на соединениях.  
- **Доступность:** ≥90/100 (ошибка при <90).
- **Инструмент:** Lighthouse CI (официальный от Google) — надежный, интегрируется с CI, предоставляет actionable-отчеты. Кастомный Node-скрипт парсит/валидирует для гибкости.  

### 4. Валидация кэша картинок
- **Что проверяет:** Сканирует страницу на изображения (img-теги, фоны), загружает заголовки с CDN/Yandex, валидирует Cache-Control.  
- **Типы:**  
  - Static Media (/next/static/media): max-age=31536000 (1 год) 
  - Dynamic Images (Yandex через /next/image): max-age=3600 (1 час). 
- **Приемлемые значения:** Точное совпадение с ожидаемым (никаких вариаций — ошибка при сбое).  
- **Инструмент:** Playwright (автоматизация браузера) — имитирует реальную навигацию, надежно захватывает все изображения. Curl для хедеров (просто).  
- **Текущие результаты:** Все проходят (например, 29 URL проверено, 0 сбоев — кэш эффективен).


TODO:
Подумать над периодичностью запуска каждого вида тестов, исходя из стоимости
Подумать над инструментов нагрузки сайта с отслеживанием прогрузки медиа на сайте (вместо playwright)
Добить тест на сайтмап (создание страницы через CMS + проверка sitemap через curl на local-env)


